<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Mini Online Game</title>
    <style>
        body { margin: 0; }
        canvas { background: #111; display: block; margin: auto; }
    </style>
</head>
<body>
<canvas id="game" width="1000" height="1000"></canvas>
<script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    let players = {};
    let myId = null;
    let x = 500, y = 500; // старт в центре
    const speed = 2.5;

    const keys = {}; // хранение нажатых клавиш

    // подключение к WebSocket серверу
    const ws = new WebSocket("ws://" + location.host + "/ws");

    ws.onmessage = (event) => {
        players = JSON.parse(event.data);
        if (!myId) {
            console.log(myId, players, x, y);
            // ищем свой id по совпадению координат
            for (let id in players) {
                if (players[id].x === x && players[id].y === y)
                    myId = id;
            }
        }
    };

    function sendPosition() {
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ x: Math.round(x), y: Math.round(y) }));
        }
    }

    // обработка клавиш
    document.addEventListener("keydown", (e) => { keys[e.key] = true; });
    document.addEventListener("keyup",   (e) => { keys[e.key] = false; });

    // обновление позиции
    function update() {
        let dx = 0, dy = 0;
        if (keys["w"]) dy -= 1;
        if (keys["s"]) dy += 1;
        if (keys["a"]) dx -= 1;
        if (keys["d"]) dx += 1;

        if (dx !== 0 || dy !== 0) {
            // нормализуем, чтобы диагональ не была быстрее
            let len = Math.sqrt(dx*dx + dy*dy);
            dx /= len; dy /= len;

            x += dx * speed;
            y += dy * speed;

            // не выходить за границы
            x = Math.max(10, Math.min(990, x));
            y = Math.max(10, Math.min(990, y));

            sendPosition();
        }
    }

    // рендер
    function loop() {
        update();

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let id in players) {
            let p = players[id];
            ctx.fillStyle = (id === myId) ? "red" : "white";
            ctx.beginPath();
            ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
            ctx.fill();
        }
        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
